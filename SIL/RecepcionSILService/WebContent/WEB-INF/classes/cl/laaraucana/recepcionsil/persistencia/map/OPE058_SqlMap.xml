<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="OPE05701_ILFSERING">
  <typeAlias alias="ilfpre1000" type="cl.laaraucana.recepcionsil.service.vo.LicenciaVO" />
  <typeAlias alias="ilf8600" type="cl.laaraucana.recepcionsil.service.vo.Ilf8600VO" />
  <typeAlias alias="ilf1100" type="cl.laaraucana.recepcionsil.service.vo.Ilf1100VO" />
  <typeAlias alias="ilfe031" type="cl.laaraucana.recepcionsil.service.vo.Ilfe031VO" />
  <typeAlias alias="ilfe033" type="cl.laaraucana.recepcionsil.service.vo.Ilfe033VO" />
  <typeAlias alias="ilfe034" type="cl.laaraucana.recepcionsil.service.vo.Ilfe034VO" />
  <typeAlias alias="ilfeOpe" type="cl.laaraucana.recepcionsil.service.vo.IlfeOpeVO"/>
  <typeAlias alias="ilfPersist" type="cl.laaraucana.recepcionsil.service.vo.PersistVO"/>
   <resultMap class="cl.laaraucana.recepcionsil.persistencia.dto.Ilfsering" id="abatorgenerated_IlfseringResult">
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Tue May 12 14:43:19 ART 2015.
    -->
	<result column="AFIRUT" jdbcType="CHAR" property="afirut" />
	<result column="NUMIMPRE" jdbcType="NUMERIC" property="numimpre" />
	<result column="LICHASFEC" jdbcType="NUMERIC" property="lichasfec" />
	<result column="CODEST" jdbcType="NUMERIC" property="codest" />
	<result column="GLOEST" jdbcType="CHAR" property="gloest" />
	<result column="FHINGJAV" jdbcType="NUMERIC" property="fhingjav" />
	<result column="FHINGAS4" jdbcType="NUMERIC" property="fhingas4" />
	<result column="REINTENTO" jdbcType="NUMERIC" property="reintento" />
	<result column="SAPCRM" jdbcType="CHAR" property="sapcrm" />
	<result column="FECEMI" jdbcType="NUMERIC" property="fecemi" />
	<result column="COCOCP" jdbcType="NUMERIC" property="cococp" />
	<result column="CODPREV" jdbcType="CHAR" property="codprev" />
	<result column="CALTRABAJ" jdbcType="NUMERIC" property="caltrabaj" />
	<result column="CONDURIND" jdbcType="NUMERIC" property="condurind" />
	<result column="TRAAFIAFC" jdbcType="NUMERIC" property="traafiafc" />
	<result column="EXCCOMPIN" jdbcType="NUMERIC" property="exccompin" />
	<result column="EXCCONSOL" jdbcType="NUMERIC" property="excconsol" />
	<result column="FECRECEP" jdbcType="NUMERIC" property="fecrecep" />
   </resultMap>
  
  	<insert id="insertServIng" parameterClass="cl.laaraucana.recepcionsil.persistencia.dto.Ilfsering">
    insert into ${SCHEMA}.ILFSERING (AFIRUT, NUMIMPRE, LICHASFEC, CODEST, GLOEST, FHINGJAV, FHINGAS4,
      REINTENTO, SAPCRM, FECEMI, COCOCP, CODPREV, CALTRABAJ, CONDURIND, TRAAFIAFC, EXCCOMPIN, EXCCONSOL, FECRECEP)
    values (#afirut#, #numimpre#, #lichasfec#, #codest#, #gloest#,
      #fhingjav#, #fhingas4#, #reintento#, #sapcrm#, #fecemi#, #cococp#, 
      #codprev#, #caltrabaj#, #condurind#, #traafiafc#, #exccompin#, #excconsol#, #fecrecep#) with nc
  	</insert>
  	
	<insert id="insertServIng_V" parameterClass="cl.laaraucana.recepcionsil.persistencia.dto.Ilfsering">
    insert into CMSQASINC.ILFSERING (AFIRUT, NUMIMPRE, LICHASFEC, CODEST, GLOEST, FHINGJAV, FHINGAS4,
      REINTENTO, SAPCRM, FECEMI, COCOCP, CODPREV, CALTRABAJ, CONDURIND, TRAAFIAFC, EXCCOMPIN, EXCCONSOL, FECRECEP)
    values (#afirut#, #numimpre#, #lichasfec#, #codest#, #gloest#,
      #fhingjav#, #fhingas4#, #reintento#, #sapcrm#, #fecemi#, #cococp#, 
      #codprev#, #caltrabaj#, #condurind#, #traafiafc#, #exccompin#, #excconsol#, #fecrecep#) with nc
  	</insert>
  	
  	<insert id="insertIlfpre1000" parameterClass="ilfpre1000">
		INSERT INTO ${SCHEMA}.ILFPRE1000 (AFIRUT,AFIRUTDV,AFINOM,LICDESFEC,LICHASFEC,OFIPGO,OFICOD,EMPRUT,EMPRUTDV,EMPSUC,
		LICIMPNUM, NUMIMPRE,LICDIAS,AFISUBTIP,AFITIP,AFIEDAD,LICCODSAL,LICDECFEC,
		LICINDCRE,LICESTCAR,LICUSRCRE,LICFECCRE,LICHRACRE,LICINSPRE,LICCONIND,LICFECING) 
		values (#rutAfiliado#,#dvRutAfiliado#,#fullName#,#fechaDesde#,#fechaHasta#,#oficinaPago#,#oficinaEmisora#,#rutEmpresa#,#dvRutEmpresa#,#sucursalCtaCte#,
		#nroLicencia#, #nroLicenciaExterna#,#diasLicencia#,#tipoLicencia#,#calidadTrabajador#,#edadAfiliado#,#servicioSalud#,#oficinaIngreso#,
		#indiceCreacion#,#estadoCarga#,#identifUsuario#,#fechaCreacion#,#horaCreacion#,#codigoInstPrevision#,#formaPago#,#fechaIngreso#)
		WITH NC
  	</insert>
  	
  	<insert id="insertIlfpre1000_V" parameterClass="ilfpre1000">
		INSERT INTO CMSQASINC.ILFPRE1000 (AFIRUT,AFIRUTDV,AFINOM,LICDESFEC,LICHASFEC,OFIPGO,OFICOD,EMPRUT,EMPRUTDV,EMPSUC,
		LICIMPNUM, NUMIMPRE,LICDIAS,AFISUBTIP,AFITIP,AFIEDAD,LICCODSAL,LICDECFEC,
		LICINDCRE,LICESTCAR,LICUSRCRE,LICFECCRE,LICHRACRE,LICINSPRE,LICCONIND,LICFECING) 
		values (#rutAfiliado#,#dvRutAfiliado#,#fullName#,#fechaDesde#,#fechaHasta#,#oficinaPago#,#oficinaEmisora#,#rutEmpresa#,#dvRutEmpresa#,#sucursalCtaCte#,
		#nroLicencia#, #nroLicenciaExterna#,#diasLicencia#,#tipoLicencia#,#calidadTrabajador#,#edadAfiliado#,#servicioSalud#,#oficinaIngreso#,
		#indiceCreacion#,#estadoCarga#,#identifUsuario#,#fechaCreacion#,#horaCreacion#,#codigoInstPrevision#,#formaPago#,#fechaIngreso#)
		WITH NC
  	</insert>
  	
  	<select id="getOficina" resultClass="java.lang.Integer">
		SELECT COUNT(*)  FROM ${SCHEMA}.ILFOFICINA
		WHERE OFICINA=#oficinaIngreso#
  	</select>
  	
  	<select id="getNumeroLicenciaCaja" resultClass="java.math.BigDecimal">
		SELECT NUMIMPRELA  FROM ${SCHEMA}.ILFE002R
		WHERE NUMIMPRE=#nroLicenciaExterno#
		fetch first 1 rows only
  	</select>
  	
  	<select id="getEmpleador" resultClass="java.util.HashMap">
		SELECT EMPRUT||'' as EMPRUT	, EMPRUTDV  FROM ${SCHEMA}.ILF8600
		WHERE AFIRUT=#rutAfiliado#
		AND NUMIMPRE= #nroLicencia#
  	</select>
  	
  	<select id="getNomEmpresa" resultClass="java.lang.String">
		SELECT CMPA  FROM CMDTA.CM02F1
		WHERE CMNA= #rutEmpresa#
  	</select>
	
	<select id="getNombreEntidad" resultClass="java.lang.String">
		SELECT TGLOSA  FROM general.taf1000
		WHERE TLETRA= 'IB'
		AND TCODIGO = #codigo#
  	</select>
	
	<select id="getServicioSalud" resultClass="java.lang.Integer">
		SELECT tvalor FROM general.taf1000
		WHERE tletra= 'IX'
		AND tcodigo= #oficinaIngreso#
  	</select>
  	
	<resultMap id="returnOpe" class="ilfeOpe">
		<result property="codOpe" column="CODOPE"/>
		<result property="ideOpe" column="IDEOPE"/>
		<result property="urlOpe" column="URLOPE"/>
		<result property="codCcaf" column="CODCCAF"/>
		<result property="pwdCcaf" column="PWDCCAF"/>
	</resultMap>
	
	<select id="getIlfeOpe" resultMap="returnOpe">
		SELECT distinct a.ideope, a.codope, a.urlope, a.codccaf, a.pwdccaf 
		FROM ${SCHEMA}.ilfeope a, ${SCHEMA}.ilfe002R b
		WHERE a.ideope=b.ideope
		AND b.numimpre = #nroLicenciaExterno#
		AND b.afirut= #rutAfiliado#
  	</select>
  	
  	<select id="getIlfSering" resultClass="java.util.HashMap">
		SELECT FECEMI, COCOCP, CODPREV, CALTRABAJ, CONDURIND, TRAAFIAFC, EXCCOMPIN, EXCCONSOL, FECRECEP			 
		FROM ${SCHEMA}.ILFSERING
		WHERE numimpre= #nroLicencia#
		AND afirut= #rutAfiliadoFull#
		AND CODEST= 3
  	</select>
  	
  	<select id="getLicenciasAnteriores" resultClass="java.util.HashMap">
  		select LICDIAS, LICDESFEC, LICHASFEC from liexp.ilf1000
		where afirut= #rutAfiliado#
		and emprut= #rutEmpresa#
		order by licdesfec desc
		fetch first 3 rows only
  	</select>
  	
  	<select id="getTieneLicenciasAnteriores" resultClass="java.lang.Integer">
  		select count(*) from liexp.ilf1000
		where afirut= #rutAfiliado#
		and emprut= #rutEmpresa#
  	</select>


  	<update id="updateIlf1010" parameterClass="java.util.HashMap">
		UPDATE ${SCHEMA}.ILF1010
		SET RUTPRO = #rutProfesional# , 
		RUTPRODV = #dvRutProfesional#,
		LICCONTRA = #fechaContrato#
		where afirut= #rutAfiliado#
		and numimpre= #nroLicencia#
	</update>
	
	<update id="updateIlf8600" parameterClass="ilf8600">
		UPDATE ${SCHEMA}.ILF8600 
		SET RUTMEDICO = #rutProfesional# , 
		RUTMEDIDV = #dvRutProfesional#,
		ACTLABOR = #actividadLaboralTrabajador#,
		OCUPACI = #ocupacionTrabajador#,
		INITRAINV = #inicioTramiteInvalidez#,
		RECUPER = #recuperabilidad#,
		LICTIPREP = #tipoReposo#,
		JORREPOSO = #jornadaReposo#,
		LUGREPOSO = #lugarReposo#,
		JUSREPOSO = #justificarOtro#,
		DIRREPOSO = #direccionReposo#,
		TELREPOSO = #telefonoReposo#,
		MESCONCEP = #mesConcepcion#,
		ESTADO = #estadoLicencia#,
		DIRTRABAJO = #direccionEmpleador#,
		TELTRABAJO = #telefonoEmpleador#,
		LICRTAIMP = #rentaImponible#,
		RTAIMP90 = #remuneracionMesAnterior#,
		AFILAFC = #trabajadorAfiliadoAFC#,
		CONTINDEF = #contratoDuracionIndefinido#,
		LICFECAFI = #fechaAfiliacion#,
		LICCONTRA = #fechaContrato#,
		LICPER1 = #periodoRenta1#,
		LICPER2 = #periodoRenta2#,
		LICPER3 = #periodoRenta3#,
		LICPER4 = #periodoRenta4#,
		LICPER5 = #periodoRenta5#,
		LICPER6 = #periodoRenta6#
		WHERE AFIRUT=#rutAfiliado# AND NUMIMPRE = #nroLicencia#
		WITH NC
	</update>
	
	<insert id="insertIlf1100" parameterClass="ilf1100">
		INSERT INTO ${SCHEMA}.ILF1100 (AFIRUT,EMPRUT,PERIODO,INSPREPER,RENTA,SUBSIDIO,DIASSIL) 
		values (#rutAfiliado#,#rutEmpleador#,#periodoRenta#,#codigoEntidadPrevisional#,#totalRemuneraciones#,#montoSubsidio#,#numeroDiasSubsidio#)
		WITH NC
  	</insert>
  	<insert id="insertIlfe031" parameterClass="ilfe031">
		INSERT INTO ${SCHEMA}.ILFE031 (IDEOPE,CODOPE,AFIRUT,NUMIMPRE,NUMIMPDV,ENVIADA,FECPROCE,RESPWS,MARCA,C1EMPNOM,C1EMPRUT,C1EMPRUTDV,C1EMPFECRE,C1EMPDIR,C1EMPCIU,C1EMPPAI,C1EMPCOM,C1COCOCP,
		C1COACLA,C1COOCUP,C1EMOTOC,C2FERECCAF,C2CODTIPRE,C2COREPREV,C2COLETCAJ,C2PREVNOM,C2COCAAFIL,C2SEGAFC,C2COSEINDE,C2FECFILIA,C2FECCONTR,C2CODENTPA,C2PRENOMAF,C3MTOIMPO,C4LICANT,
		CODCCAF,PWDCCAF,URLOPE,USERACT,NOMCON,HORENV) 
		values (#ideOpe#,#codOpe#,#rutAfiliado#,#nroLicencia#,#dvNroLicencia#,#enviada#,#fechaProceso#,#respuestaWS#,#marcaProcesado#,#nombreEmpleador#,#rutEmpleador#,#dvRutEmpleador#,#fechaRecepcionEmpresa#,#direccionEmpleador#,#ciudadEmpleador#,#paisEmpleador#,#comunaEmpleador#,#codigoComunaCompin#,
		#codigoActividadLaboral#,#codigoOcupacion#,#otraOcupacion#,#fechaRecepcionCaja#,#codigoTipoRegimenPrevisional#,#codigoEntidadPrevisonal#,#codigoLetraCaja#,#nombreEntidadPrevisional#,#codigoCalidadTrabajador#,#trabajadorAfiliadoAFC#,#contratoDuracionIndefinido#,#fechaAfiliacion#,#fechaContrato#,#codigoEntidadPagadora#,#nombreEntidadPagadora#,#rentaImponible#,#licenciasAnteriores#,
		#codCcaf#,#pwdCcaf#,#urlOpe#,#usuarioModifica#,#nombreConsumo#,#horaEnvio#)
		WITH NC
  	</insert>
	
  	<update id="updateIlf031" parameterClass="ilfe031">
		UPDATE ${SCHEMA}.ILFE031
		SET ENVIADA=#enviada#,
		RESPWS = #respuestaWS#,
		GLORESP = #glosaRespuesta#, 
		FECRESP = #fechaRespuesta#,
		HORRESP = #horaRespuesta#
		where IDEOPE = #ideOpe#
		and NUMIMPRE = #nroLicencia#
	</update>

  	<insert id="insertIlfe033" parameterClass="ilfe033">
		INSERT INTO ${SCHEMA}.ILFE033 (AFIRUT,EMPRUT,PERIODO,INSPREPER,DIASREMANT,MTOTOTANT,MTOINCAANT,DIASINCANT,FECPROCE) 
		values (#rutAfiliado#,#rutEmpleador#,#periodoRenta#,#codigoEntidadPrevisional#,#numeroDiasRemuneracion#,#totalRemuneraciones#,#montoSubsidio#,#numeroDiasSubsidio#,#fechaProceso#)
		WITH NC
  	</insert>
  	
  	<insert id="insertIlfe034" parameterClass="ilfe034">
		INSERT INTO ${SCHEMA}.ILFE034 (AFIRUT,EMPRUT,NUMIMPRE,NDIAS,FECDESDE,FECHASTA,FECPROCE) 
		values (#rutAfiliado#,#rutEmpleador#,#nroLicencia#,#numeroDias#,#fechaDesde#,#fechaHasta#,#fechaProceso#)
		WITH NC
  	</insert>
  	
  	<resultMap class="java.util.HashMap" id="endPointsMap">
		<result property="key" column="codigo"/>
	    <result property="value" column="endpoint"/>      
	</resultMap>
	
  	<select id="getEndPoints" resultMap="endPointsMap" parameterClass="string">
		<!-- SELECT BAN_CODIGO as CODIGO, BAN_COD_HMG AS ENDPOINT FROM T_BANCO -->
		SELECT o.IDEOPE, trim(o.URLOPE)||trim(d.URLDETOPE) endpoint, d.NOMSER
			, o.NOMOPE as NOMSER, o.CODOPE, trim(o.CODOPE)||','||REPLACE(trim(d.NOMSER), ' ', '_')||','||'$value$' codigo
			FROM  LIEXP.ILFEDETOPE d , LIEXP.ILFEOPE o
			WHERE 	o.IDEOPE=d.IDEOPE and  
			d.STSDETOPE = 1 and 
			o.STSOPE = 1
			WITH UR
	</select>
	
	<resultMap id="parametrosMap" class="java.util.HashMap" >
     	<result column="NOMBRE" property="key"/>
     	<result column="VALOR" property="value"/>
  	</resultMap>
  
	<select id="getParametros" resultMap="parametrosMap">		
		SELECT TRIM(NOMBRE) NOMBRE, TRIM(VALOR) VALOR 
		FROM LIEXP.ILFE083 
	</select>
	
	<insert id="insertIlfPersist" parameterClass="java.util.HashMap">
		INSERT INTO ${SCHEMA}.ILFPERSIST (AFIRUT,NUMIMPRE,CODEST,LICENCIA) 
		values (#rutAfiliadoFull#,#nroLicencia#,0,#licencia:BLOB#)
		WITH NC
  	</insert>
  	
  	<resultMap class="ilfPersist" id="PersistBLOB">
  	<result column="afirut" property="afirut" />
   	<result column="numimpre" property="numimpre" />
   	<result column="licencia" property="data" jdbcType="BLOB"/>
   	</resultMap>
   
  	<select id="getLicenciasPersist" resultMap="PersistBLOB">
  		select AFIRUT, NUMIMPRE, LICENCIA from ${SCHEMA}.ILFPERSIST 
		where CODEST= #estado#
  	</select>
  	<update id="updateIlfPersist" parameterClass="java.util.HashMap">
		UPDATE ${SCHEMA}.ILFPERSIST
		SET CODEST = 1
		where afirut= #rutAfiliadoFull#
		and numimpre= #nroLicencia#
	</update>
</sqlMap>